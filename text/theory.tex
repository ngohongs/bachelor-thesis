\chapter{Základ teorie mechaniky tekutin}
 
 V této kapitole je shrnutí teorie mechaniky tekutin, která je nezbytnou součástí pro simulování fyzikálně korektního chování vody. Teorie je zde vyložena takovým způsobem, aby byl čtenář s ní seznámem a co nejrychleji pochopil principy chování tekutin, neobsahuje žádné rigorózní vysvětlení problematiky.
 
    \section{Navierovy--Stokesovy rovnice}
    
        Proud tekutin se v reálném světě řídí podle Navierovými--Stokesový rovnicemi, soustavou nelinearních diferenciálních rovnic.
    
        \begin{equation}
            \nabla \cdot \vec{u} = 0 \label{eq:mass_conservation}
        \end{equation}
        \begin{equation}
            \frac{ \partial \vec{u}}{\partial t} + \vec{u} \cdot \nabla \vec{u} + \frac{1}{\rho} \nabla p = \vec{g} + \nu \nabla \cdot \nabla \vec{u} \label{eq:momentum_conservation}
        \end{equation}
    
        Kde vektor $ \vec{u} = (u, v, w) $ označuje rychlost tekutiny, $ \rho $ označuje hustotu tekutiny, $ p $ tlak, kterým působí tekutina na své okolí, $ \vec{g} = (x, y, z) $ je gravitační zrychlení, $ \nu $ je značení kynematické viskozity tekutiny. Symboly $ \nabla$, $ \nabla \cdot $, $ \nabla \cdot \nabla $ označují diferenciální operátory nabla, divergence a Laplacův operátor.  
    
            \subsection{Vysvětlení}
                Před vysvětlení jednotlivých rovnic je dobré zmínit, že většina teorie mechaniky tekutin je založena na odvětví matematiky vektrové analýzy a pracují s vektorovými poli, resp. skalárními poli. Navierovy--Stokesovy rovnice např. pracují s vektorovým poli, resp. se skalárními poli, kde jednotlivým bodům prostoru přiřazují vektor určující rychlost proudu tekutiny, resp. hodnotu tlaku.
    
                Na první pohled vypadají rovnice těžce uchopitelné, ale myšlenka za nimi je velmi jednoduchá. První rovnice \ref{eq:mass_conservation} popisuje zákon o zachování hmotnosti, tím je myšleno, že není možné, aby hmota tekutiny na některém místě vznikla nebo zanikla.
    
                Druhá rovnice \ref{eq:momentum_conservation} popisuje zákon o zachování hybnosti a je ve své podstatě Newtonův druhý zákon.
                
                \begin{equation}
                    \vec{F} = m \vec{a} \label{eq:newton_second}
                \end{equation}
    
                Zrychlení $ \vec{a} $ lze přepsat je derivací rychlosti podle času.

                \begin{equation}
                    \vec{F} = m \frac{D \vec{u}}{D {t}} \label{eq:first_step}
                \end{equation}

                Pro odvození celé rovnice je třeba rozvést sílu $ \vec{F} $, které na tekutinu působí. Jedna z nich je samozřejmě gravitace, jejíž hodnota je vyčíslena jako $ m\vec{g} $.
    
                Další síly vytváří tekutina sama na sobě. První z nich je síla způsobena rozdílem tlaků v tekutině. Tekutina se v oblastech s vyšším tlakem přesouvá do oblastí s nižším tlakem. Její hodnotu můžeme zapsat jako $ \minus V \nabla p $ \footnote{Operace $\nabla p$ vyjadřuje vektorové pole, ve kterém vektory směřují, z jednotlivých bodů na své blízké okolí, aby jeho hodnota ve skalárním poli nejrychleji vzrostla.}. 
        
                Další síla působící na tekutinu je ovliněna její viskozitou. Viskozita působí při každém pohybu částic tekutiny [lecture notes] a snaží se vyrovnat rychlost částic rychlostí svých sousedních částic. Její hodnotu můžeme vyjádřit jako\:$  V \mu \nabla \cdot \nabla \vec{u} $ \footnote{Operace $ \nabla \cdot \nabla \vec{u} $ vyjadřuje míru deviace rychlosti částice okolo svého okolí.}, kde $ \mu $ označuje koeficient dynamické viskozity.
    
                \begin{equation}
                    m \vec{g} - V \nabla p + V \mu \nabla \cdot \nabla \vec{u} = m \frac{D \vec{u}}{Dt} \label{eq:second_step}
                \end{equation}
    
                Rovnice \ref{eq:newton_second}, \ref{eq:first_step} a \ref{eq:second_step} předpokládají, že tekutinu lze rozložit na konečně mnoho malých částí, tímto způsobem je do výpočtu představena výpočetní chybu. Řešením toho problému je celou rovnici \ref{eq:second_step} je vydělit $V$, aby zachytila pohyb nekonečně mnoho malých částic tekutin. Dobré je připomenout, že hustota $\rho$ lze vyjádřit jako $\frac{m}{V}$
    
                \begin{equation}
                    \rho \vec{g} - \nabla p + \mu \nabla \cdot \nabla \vec{u} = \rho \frac{D \vec{u}}{D \vec{t}}  
                \end{equation}
    
                Následně po vydělení hustoty $\rho$, vyjádření derivace $\frac{D\vec{u}}{Dt}$ řetízkovým pravidlem a prohození sčítanců získáme druhou Navierovu--Stokesovu rovnici. Kynematická vyskozita $\nu$ je rovna $\frac{\mu}{\rho}$.
    
                \begin{equation}
                    \frac{\partial \vec{u}}{\partial \vec{t}} + \vec{u} \cdot \nabla \vec{u} + \frac{1}{\rho} \nabla p = \vec{g}  + \nu \nabla \cdot \nabla \vec{u} 
                \end{equation}
                
        \section{Využití}
            Výhodou Navierovy--Stokesovy rovnic je, že lze aplikovat na téměř jakékoliv tekutiny, a tím padem je možné využitím pro modelování počasí, podnebí pro předpověď počasí, proudění v oceánech, výpočtu aerodynamických vlastností vozidel. Přestože využití rovnic je nespočetné, mají zásadní problém, neboť do dnes nevíme, zdali mají pro náhodný vstup nějaké řešení. Pro zjednodušení výpočtu existují několik aproximací, které je umožňují využít se zanedbatelnými chybami v modelovacích systémech.
            
        \section{Popisy tekutiny}

            V teorii mechaniky tekutin existují dva různé pohledu popisů. Na základě těchto popisů jsou následně založeny algoritmy pro simulaci kapalin, resp. plynů, které jich využívají pro diskretizaci Navierových--Stokesových rovnic.


            \subsection{Lagrangeův popis}

                Lagrangeův popis je jeden z popisů kontinua, který si většina nejspíše vybaví. Na tekutinu nahlíží jako na systém částic. Na jednotlivé body tekutiny nahlíží jako částice. Částice mohou být na základě potřeby různě velké, např. jako molekule nebo části tekutiny o nějakém objemu. Každé části Lagrangeův popis přiradí jeho pozici $\vec{x}$ a rychlost $\vec{u}$ a sleduje ho, jak se hodnoty v čase mění.

            \subsection{Euleurův popis}
            
                Euleurův popis kontinua je na první pohled neintuitivní. Eulerův postup diskretizuje prostor tekutiny na pevně dané oblasti, ve kterých měří vlastnosti tekutiny jako např. tlak, rychlost proudu, teplotu, jak se v čase mění. Přestože tento postup vypadá omezující a složitý kvůli sledování veličin tekutin jen v pevných bodech, je v metodách pro simulování tekutin preferovaným popisem kontinua.

            

 
 

\chapter{Vlastnosti vodního povrchu}

    Tato kapitola obsahuje popis vizuální vlastnosti vodní hladiny, které v reálném lze zpozorovat a k jejím hlavním rysům jsou vypsané algoritmy, které je simulují. Z\,pohledu počítačové grafiky lze vlastnosti vody lze rozdělit do dvou kategorií:

    \begin{description}
    \item[dynamické vlastnosti] popisující pohyb vodní hladiny,
    \item[světelné vlastnosti] popisující interakce povrch vody se světelnými prsky.
    \end{description}

    \section{Dynamické vlastnosti}

        Dynamické vlastnosti zachycují, jak se vodní hladina pohybuje a jak reaguje na dynamické prostředí.

        V současnosti nejrealističtější výsledků je dosaženo simulací Eulerovy vody (nahlíží na vodu Eulerovým popisem), jejíž prostor je rozdělen do alespoň 512\textsuperscript{3} buněk. Takto řídké rozdělení obsahuje přes 100 milion neznámých pro vyřešení a s užitím globálních zobrazovacíh metod jako ray-tracing pro realistickou vizualci odrazů, refrakcí a kaustik je výpočetně nemožné simulovaci provést v reálném čase [MuellerGDC08].


        \begin{figure}\centering
            \includegraphics[width=0.5\textwidth]{img/Guendelman2005}
            \caption{Ukázka off-line simulace Eulerovy tekutiny [Guendelman05]}\label{fig:guendelman-offline}
        \end{figure}

        Proto real-time simulace vody vhodná pro aplikace jako hry musí nutně splňovat tyto podmínky [MuellerGDC08]:

        \begin{itemize}
        \item být výpočetně rychlá -- zlomek 15 ms, který je třeba pro vykreslení jednoho snímku,
        \item být paměťově nenáročná,
        \item být stabilní -- korektně reagovat i na nefyzikálně pohybující se objekty.
        \end{itemize}

        \newpage 

        Jeden přístup, jak se co nejvíce příblížit off-line simulaci a stále dodržet podmínky pro rea-time simulaci ve hrách, je zachovat stejný algoritmus jako při off-line simulaci, ale zmenšit rozlišení prostoru simulace. Tento postup ale spíše ubírá na realitě vodního povrchu, neboť se voda nefyzikálně shlukuje a detaily z obrazu jsou vynechány.

        Další z možností, jak splnit výše zmíněné podmínky, je omezit míru interakce s vnějším prostředím, která tvoří největší výpočetní překážku. Na základě významnosti vodních útvarů ve scéně může simulace reagovat na všechny rigidní tělesa nebo u případů, ve kterých voda slouží jako pozadí, opominout jakoukoliv interakci.

        Podle tohodle principu můžeme dělit metody simulace vodní plochy na [MuellerGDC08]:

        \begin{itemize}
        \item procedulární
        \item částicové
        \item hybridní
        \end{itemize}

            \subsection{Procedulární metody}

                Procedulární metody simulují konečné efekty jako vlnění vodního povrchu, které nejsou vyvolány fyzikální činitily. Největší výhodou této metody je výpočetní rychlost a versetalita, na druhou stranu ale vodní útvary nereagují na dynamické prostředí.

                Na základě tichto vlastností se procedulární metody používají pro vizualici rozsáhlé vodní plochy, které ve scéně hraje malou roli, např. jako oceán v pozadí scény.

                \subsubsection{Vlnění za pomocí sinusoid}
                    Mezi prvními, kdo zkoumal procedulární metody pro zobrazení vodního povrchu byl Nelson. L Max ve své práci \uv{Vectorized Procedural Models for Natural Terrain: Wave and Islands in the Sunset}, ve které modeluje vlnění povrchu pomocí sinusoid. Na základě horizontální pozici a času Max manipuloval výšku vrcholů roviny [Max81]. Výšku jednotlivých vrcholů roviny vyjádřil jako funkci

                    \begin{equation}
                        h(x, z, t) = -y_0 + A \sin (k_{x}x+k_{z}z-\omega t + \varphi), \label{eq:sin_wave}
                    \end{equation}

                    \noindent kde $(x, z)$ je horizontální pozice vrcholu roviny (v celé práci se bude považovat, že kladná osa y směřuje nahoru), $t$ je čas, $y_0$ je výška hladiny vody v klidovém stavu (při nulovém výskytu vln), $A$ reprezentuje amplitudu roviny, $\vec{k} = (k_x, k_z)$ je vlnový vektor reprezentující směr a rychlost propagace vln, $\omega$ je úhlová frekvence a $\varphi$ je fáze vlny.

                    \begin{figure}\centering
                        \includegraphics[width=0.5\textwidth]{img/sin_wave}
                        \caption{Simulace vlnění pomocí jedné sinusoidy}\label{fig:3d_sin_wave}
                    \end{figure}
                    
                    Tento model se ale vlní jen v jednom směru a výsledné vlny vypadají nerealisticky hladce. K dosažení větších detailů lze k funkci přičíst další funkce sinus s odlišnými parametry amplitudy, vlnového vektoru nebo úhlové frekvence:  

                    \begin{equation}
                        h(x, z, t) = -y_0 + \sum_{i=1}^{N_w} A_i \sin (k_{x_i}x+k_{z_i}z-\omega_i t + \varphi_i), \label{eq:sin_wave_sum}
                    \end{equation}

                    \noindent kde $N_w$ je celkový počet vln.

                    \begin{figure}\centering
                        \includegraphics[width=0.5\textwidth]{img/sin_wave_sum}
                        \caption{Simulace vlnění pomocí sčítání sinusoid}\label{fig:3d_sin_wave_sum}
                    \end{figure}
                    
                    \newpage 
                    
                    Realistického řešení však za pomocí jen obyčejných sinusoid nelze dosáhnout. Max si všiml, že vlnění oceánu s vyššími amplitudami mají užší hřeben a mělčí údolí, zatímco vrchol a údolí sinusoidy je oblý. Mark Finch a Cyan Worlds přišly s řešením toho problém ve svém článku \uv, které stále využívá jednoduché funkce sinus. Kromě obyčejných funkcí sinus přičítá navíc funkci
                    
                    \begin{equation}
                        f_i(x,z,t) = -y_0 + 2 \left( \frac{\sin (k_{x_i} x + k_{z_i} z - \omega_i t + \varphi_i) + 1}{2} \right)^k, \label{eq:sin_better}
                    \end{equation}
                    
                    \noindent kde $ k \in \mathbb{R}^+ $ určuje míru, jak má být hřeben [GPUGems1].
                    
                    \begin{figure}\centering
                        \includegraphics[width=\textwidth]{img/sin_better}
                        \caption{Porovnání mezi vlnami funkcí \ref{eq:sin_wave} a \ref{eq:sin_better}}\label{fig:sin_better}
                    \end{figure}
                
                \subsubsection{Vlnění za pomocí Gerstnerovy vlny}
                    Limitující faktor metody založené na transformaci vrcholů pomocí sinusoid je, že manipuluje s jediným parameter vrcholu, tj. výškou, a pro realističtější výsledky bylo třeba manipulovat vrcholy i v horizontální rovině. Tento problém řeší cyklické křivky, tzv. trochoidy, podle kterých Franz Josef Gerstner, německý fyzik, modeloval vlnění hladiny v hlubokých  [Gerstner1802]. Trochoidou nazýváme trajektorii bodu pevně spojeného s \uv{kotálející se} kružnice po nehybné přímce \url{https://www.fa.cvut.cz/studium/predmety/deskriptivni-geometrie-i-ii/dg_elskripta/krivky/cyklicke_krivky_1.pdf}.
                    
                    \begin{figure}\centering
                        \includegraphics[width=0.75\textwidth]{img/trochoidal_wave}
                        \caption{Gerstnerova vlna s fázovou rychlostí $ c $, vlnovou délkou $ \lambda $ a rozdílem hřebenu a údolí $ H $}\label{fig:trochoidal_wave}
                    \end{figure}
                    
                    Dnes v teorii dynamiky tekutin vlnění založené na trochoidních křivkách nazýváme Gerstnerovy vlny. Mezi prvními, kdo se Gerstnerovými vlnami zabýval byli Alain Fournier a William T. Reeves, kteří transformovali vrcholy roviny podle tichto parametrických rovnic [Fournier86]:
                   
                    \begin{equation}
                     x = x_0 + r \cos ( k_x x_0 + k_z z_0 - \omega t )
                    \end{equation}
                    
                    \begin{equation}
                     y = r \sin ( k_x x_0 + k_z z_0 - \omega t  )
                    \end{equation}

                    \begin{equation}
                     z = z_0 + r \cos ( k_x x_0 + k_z z_0 - \omega t  ),
                    \end{equation}
                    
                    \noindent kde vektor $(x_0, z_0)$ reprezentuje klidovou pozici vrcholu roviny, $ r $ je délka opisujícího bodu od středu kružnice trochoidní křivky, vektor $\vec{k} = (k_x, k_y)$ určuje rychlost a směr propagace vlnění, $ \omega $ označuje úhlovou frekvenci a $ t $ je čas.
                    
                    Hodnota $ s = r|\vec{k_x}| $ určuje, jak strmá bude vlna. Pro hodnutu $ s = 0.2 $ má vlna tvar jako sinusoida, pro $ s = 1 $ má tvar cykloidy a pro $ s > 1 $ dochází samoprotínání trochoidy, a proto by se hodnotám vyšší než jedna mělo vyhýbat pro vizualizaci vodního povrchu. V obrázku \ref{fig:s_comparison} je porovnání hodnot $ s $ pro vlnění ve dvourozměrném prostoru.   

                    \begin{figure}\centering
                        \includegraphics[width=0.75\textwidth]{img/s_comparison}
                        \caption{Porovnání hodnot $ s $ ve dvourozměrném prostoru} \label{fig:s_comparison}
                    \end{figure}
                    
                    Detailnějších výsledků lze získat podobně jako u sinusoid pomocí skládání Gerstnerových vln:
                    
                    \begin{equation}
                     x = x_0 + \sum_{i=1}^{N_w} r_i \cos ( k_{x_i} x_0 + k_{z_i} z_0 - \omega_i t )
                    \end{equation}
                    
                    \begin{equation}
                     y = \sum_{i=1}^{N_w} r_i \sin ( k_{x_i} x_0 + k_{z_i} z_0 - \omega_i t  )
                    \end{equation}

                    \begin{equation}
                     z = z_0 + \sum_{i=1}^{N_w} r_i \cos ( k_{x_i} x_0 + k_{z_i} z_0 - \omega_i t  ).
                    \end{equation}

                    \begin{figure}\centering
                        \includegraphics[width=0.5\textwidth]{img/gerstner_wave}
                        \caption{Implemetace Gerstnerových vln pro simulování vodního povrchu  \url{https://catlikecoding.com/unity/tutorials/flow/waves/}} \label{fig:gerstner_wave}
                    \end{figure}
                \subsubsection{Vlnění za pomocí Fourierovy Transformace}
                    Předešlé dvě metody jsou dobrý aproximacemi vodních povrchů, ale jejich




\section{Světelné vlastnosti}


